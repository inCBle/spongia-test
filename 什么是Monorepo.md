<!--
 * @Date: 2023-02-02 09:20:49
 * @LastEditors: 吴迪
 * @LastEditTime: 2023-02-02 16:28:05
 * @FilePath: \Monorepo组件库工程化架构搭建\什么是Monorepo.md
-->

## <font color='#569cd6'>什么是 monorepo</font>

> monorepo 指的是一种代码项目结构的组织方式，mono 指的是单个，repo 指的是仓库，总的就是说单个仓库。顾名思义就是把所有相关的项目都放到一个仓库中进行管理。

## <font color='#569cd6'>优点</font>

> 1. **代码重用将变得非常容易**：由于所有的项目代码都集中于一个代码仓库，我们将很容易抽离出各个项目共用的业务组件或工具，并通过 TypeScript，Lerna 或其他工具进行代码内引用；

> 2. **依赖管理将变得非常简单**：同理，由于项目之间的引用路径内化在同一个仓库之中，我们很容易追踪当某个项目的代码修改后，会影响到其他哪些项目。通过使用一些工具，我们将很容易地做到版本依赖管理和版本号自动升级；

> 3. **代码重构将变得非常便捷**：想想究竟是什么在阻止您进行代码重构，很多时候，原因来自于「不确定性」，您不确定对某个项目的修改是否对于其他项目而言是「致命的」，出于对未知的恐惧，您会倾向于不重构代码，这将导致整个项目代码的腐烂度会以惊人的速度增长。而在 monorepo 策略的指导下，您能够明确知道您的代码的影响范围，并且能够对被影响的项目可以进行统一的测试，这会鼓励您不断优化代码；

> 4. **它倡导了一种开放，透明，共享的组织文化，这有利于开发者成长，代码质量的提升**：在 monorepo 策略下，每个开发者都被鼓励去查看，修改他人的代码（只要有必要），同时，也会激起开发者维护代码，和编写单元测试的责任心（毕竟朋友来访之前，我们从不介意自己的房子究竟有多乱），这将会形成一种良性的技术氛围，从而保障整个组织的代码质量。

> 5. **统一的工作流和 Code Sharing**：比如我想看一个 pacakge 的代码、了解某段逻辑，不需要找它的 repo，直接就在当前 repo；当某个需求要修改多个 pacakge 时，不需要分别到各自的 repo 进行修改、测试、发版或者 npm link，直接在当前 repo 修改，统一测试、统一发版。

> 6. **简化依赖管理**：避免重复安装包，因此减少了磁盘空间的占用，并降低了构建时间

> 7. **统一配置**：合并同类项 - Eslint，Typescript 与 Babel

> 8. **各模块独立方便管理**（对于 element 来说，修改表单只需要修改 packages 下的 form 目录）

> 9. **结构清晰**（模块独立之后，结构自然清晰）

## <font color='#569cd6'>缺点</font>

> 1. **仓库代码体积可能比较大**（一个仓库包含多个项目，项目多了，体积自然会大）

> 2. **项目粒度的权限管理变得非常复杂**：无论是 Git 还是其他 VCS[^vcs] 系统，在支持 monorepo 策略中项目粒度的权限管理上都没有令人满意的方案，这意味着 A 部门的 a 项目若是不想被 B 部门的开发者看到就很难了。（好在我们可以将 monorepo 策略实践在「项目级」这个层次上，这才是我们这篇文章的主题，我们后面会再次明确它）；

> 2. **新员工的学习成本变高**：不同于一个项目一个代码仓库这种模式下，组织新人只要熟悉特定代码仓库下的代码逻辑，在 monorepo 策略下，新人可能不得不花更多精力来理清各个代码仓库之间的相互逻辑，当然这个成本可以通过新人文档的方式来解决，但维护文档的新鲜又需要消耗额外的人力；

> 2. **对于公司级别的 monorepo 策略而言，需要专门的 VFS[^vfs] 系统，自动重构工具的支持**：设想一下 Google 这样的企业是如何将十亿行的代码存储在一个仓库之中的？开发人员每次拉取代码需要等待多久？各个项目代码之间又如何实现权限管理，敏捷发布？任何简单的策略乘以足够的规模量级都会产生一个奇迹（不管是好是坏），对于中小企业而言，如果没有像 Google，Facebook 这样雄厚的人力资源，把所有项目代码放在同一个仓库里这个美好的愿望就只能是个空中楼阁。

## <font color='#569cd6'>monorepo 的实现方式</font>

> 常用 yarn(内置 workspack 工作区)、pnpm(pnpm 内置了对 monorepo 的支持)。

## <font color='#569cd6'>Release 工作流</font>

> 在 workspace 中对包版本管理是一个非常复杂的工作，遗憾的是 pnpm 没有提供内置的解决方案，一部分开源项目在自己的项目中自己实现了一套包版本的管理机制，比如 Vue3、Vite 等。

###### pnpm 推荐了两个开源的版本控制工具：
> 1.  [changesets](https://github.com/changesets/changesets)
> 2.  [rush](https://rushjs.io/)

简而言之就是管理包的 version 和生成 changelog

---
[参考这篇文章搭建的 monorepo + workspace + changesets 的架构](https://juejin.cn/post/7098609682519949325#heading-3)

[^vcs]: 版本控制系统
[^vfs]: 虚拟文件系统
